package com.project.VisitService.service;

import com.project.VisitService.model.Consultation;
import com.project.VisitService.repository.ConsultationRepository;
import com.project.VisitService.repository.VisitRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;

@Service
@RequiredArgsConstructor
public class ConsultationServiceImpl implements ConsultationService {

    private final ConsultationRepository consultationRepository;
    private final VisitRepository visitRepository;

    @Override
    @Transactional
    public Consultation addConsultation(Long visitId, String notes, String followUpDate) {
        // validate visit exists
        visitRepository.findById(visitId)
                .orElseThrow(() -> new RuntimeException("Visit not found: " + visitId));

        Consultation consultation = Consultation.builder()
                .visitId(visitId)
                .notes(notes)
                .followUpDate(followUpDate == null ? null : LocalDate.parse(followUpDate))
                .build();

        Consultation saved = consultationRepository.save(consultation);

        // Optionally mark visit COMPLETED
        var visit = visitRepository.findById(visitId).get();
        visit.setStatus(Visit.VisitStatus.COMPLETED);
        visitRepository.save(visit);

        return saved;
    }

    @Override
    @Transactional
    public Consultation updateConsultation(Long consultationId, String notes, String followUpDate) {
        Consultation cons = consultationRepository.findById(consultationId)
                .orElseThrow(() -> new RuntimeException("Consultation not found: " + consultationId));

        if (notes != null) cons.setNotes(notes);
        if (followUpDate != null) cons.setFollowUpDate(LocalDate.parse(followUpDate));

        return consultationRepository.save(cons);
    }
}
