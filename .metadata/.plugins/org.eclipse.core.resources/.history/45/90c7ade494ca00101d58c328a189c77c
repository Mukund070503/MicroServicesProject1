package com.project.VisitService.service;

import com.project.VisitService.dto.*;
import com.project.VisitService.model.Consultation;
import com.project.VisitService.model.Prescription;
import com.project.VisitService.model.Visit;
import com.project.VisitService.repository.ConsultationRepository;
import com.project.VisitService.repository.PrescriptionRepository;
import com.project.VisitService.repository.VisitRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class VisitServiceImpl implements VisitService {

    private final VisitRepository visitRepository;
    private final ConsultationRepository consultationRepository;
    private final PrescriptionRepository prescriptionRepository;

    private static final long DEFAULT_BASE_PRICE = 500L;

    @Override
    @Transactional
    public BookVisitResponse bookVisit(BookVisitRequest request) {
        // check last completed visit between same doctor & patient
        var optLastCompleted = visitRepository.findTopByDoctorIdAndPatientIdAndStatusOrderByScheduledTimeDesc(
                request.getDoctorId(), request.getPatientId(), Visit.VisitStatus.COMPLETED);

        boolean discountApplied = false;
        long basePrice = request.getBasePrice() == null ? DEFAULT_BASE_PRICE : request.getBasePrice();
        long finalPrice = basePrice;

        if (optLastCompleted.isPresent()) {
            var last = optLastCompleted.get();
            Duration diff = Duration.between(last.getScheduledTime(), request.getScheduledTime());
            long days = Math.abs(diff.toDays());
            if (days <= 14) {
                // apply 10% discount example
                discountApplied = true;
                finalPrice = Math.round(basePrice * 0.9);
            }
        }

        Visit visit = Visit.builder()
                .doctorId(request.getDoctorId())
                .patientId(request.getPatientId())
                .scheduledTime(request.getScheduledTime())
                .status(Visit.VisitStatus.SCHEDULED)
                .basePrice(basePrice)
                .finalPrice(finalPrice)
                .build();

        Visit saved = visitRepository.save(visit);

        return BookVisitResponse.builder()
                .visitId(saved.getVisitId())
                .isDiscountApplied(discountApplied)
                .basePrice(basePrice)
                .finalPrice(finalPrice)
                .build();
    }

    @Override
    public List<VisitHistoryDTO> getUpcomingVisitsForDoctor(Long doctorId) {
        var visits = visitRepository.findByDoctorIdAndStatusOrderByScheduledTimeAsc(doctorId, Visit.VisitStatus.SCHEDULED);
        return visits.stream().map(v -> VisitHistoryDTO.builder()
                .visitId(v.getVisitId())
                .visitTime(v.getScheduledTime())
                .doctorId(v.getDoctorId())
                .status(v.getStatus().name())
                .build()).collect(Collectors.toList());
    }

    @Override
    @Transactional
    public void updateVisitStatus(Long visitId, String status) {
        var visit = visitRepository.findById(visitId)
                .orElseThrow(() -> new RuntimeException("Visit not found: " + visitId));
        visit.setStatus(Visit.VisitStatus.valueOf(status.toUpperCase()));
        visitRepository.save(visit);
    }

    @Override
    public List<VisitHistoryDTO> getVisitHistoryForPatient(Long patientId) {
        var visits = visitRepository.findByPatientIdOrderByScheduledTimeDesc(patientId);
        return visits.stream().map(v -> {
            Long consultationId = consultationRepository.findByVisitId(v.getVisitId())
                    .map(Consultation::getConsultationId).orElse(null);
            Long prescriptionId = prescriptionRepository.findTopByVisitIdOrderByCreatedAtDesc(v.getVisitId())
                    .map(Prescription::getPrescriptionId).orElse(null);

            return VisitHistoryDTO.builder()
                    .visitId(v.getVisitId())
                    .visitTime(v.getScheduledTime())
                    .doctorId(v.getDoctorId())
                    .consultationId(consultationId)
                    .prescriptionId(prescriptionId)
                    .status(v.getStatus().name())
                    .build();
        }).collect(Collectors.toList());
    }

    @Override
    public VisitDetailsDTO getVisitDetails(Long visitId) {
        var visit = visitRepository.findById(visitId)
                .orElseThrow(() -> new RuntimeException("Visit not found: " + visitId));

        var consultationOpt = consultationRepository.findByVisitId(visitId);
        var prescriptionOpt = prescriptionRepository.findTopByVisitIdOrderByCreatedAtDesc(visitId);

        VisitDetailsDTO dto = VisitDetailsDTO.builder()
                .visitId(visit.getVisitId())
                .doctorId(visit.getDoctorId())
                .patientId(visit.getPatientId())
                .scheduledTime(visit.getScheduledTime())
                .status(visit.getStatus().name())
                .build();

        consultationOpt.ifPresent(c -> {
            dto.setConsultationId(c.getConsultationId());
            dto.setNotes(c.getNotes());
            dto.setConsultationTime(c.getCreatedAt());
            dto.setFollowUpDate(c.getFollowUpDate() == null ? null : c.getFollowUpDate().toString());
        });

        prescriptionOpt.ifPresent(p -> dto.setPrescriptionId(p.getPrescriptionId()));

        return dto;
    }

    @Override
    public LastVisitSummaryDTO getLastVisitSummaryForPatient(Long patientId) {
        var visits = visitRepository.findByPatientIdOrderByScheduledTimeDesc(patientId);
        if (visits.isEmpty()) return null;

        var lastVisit = visits.get(0);
        var consultationOpt = consultationRepository.findByVisitId(lastVisit.getVisitId());
        var prescriptionOpt = prescriptionRepository.findTopByVisitIdOrderByCreatedAtDesc(lastVisit.getVisitId());

        return LastVisitSummaryDTO.builder()
                .lastVisitId(lastVisit.getVisitId())
                .lastConsultationId(consultationOpt.map(c -> c.getConsultationId()).orElse(null))
                .lastConsultationTime(consultationOpt.map(Consultation::getCreatedAt).orElse(null))
                .lastPrescriptionId(prescriptionOpt.map(Prescription::getPrescriptionId).orElse(null))
                .build();
    }
}
